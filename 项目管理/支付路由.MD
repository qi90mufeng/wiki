要求多了，就要精细化管理



# 路由入参

- 用户
- 支付场景（业务、产品）
- 金额
- 支付方式



# 业务

* 绑卡
* 清算
* 对账文件
* 代收
* 代付 
  * 对私代付
  * 对公代付
* 代扣还款
* 代扣保费
* 协议支付
  * 协议支付签约流程![img](https://ss1.baidu.com/6ONXsjip0QIZ8tyhnq/it/u=744210922,2100934061&fm=173&app=25&f=JPEG?w=640&h=143&s=6C84A61ACD3AE4035C4830DA0200B0F3)
  * 协议支付流程

![img](https://ss0.baidu.com/6ONWsjip0QIZ8tyhnq/it/u=2923784139,1769715583&fm=173&app=25&f=JPEG?w=638&h=133&s=6812AE1ACD12E4031E4018DA02007073)



# 支付方式

* 线下支付
  * 对公支付宝
  * 对公银行卡
* 线上支付
  * 支付宝
  * 微信
  * 银行卡
    * 信用卡
    * 储蓄卡
  * 扫码支付



# 业务场景

* 消费贷
  * 自有资金
    * 信托方式
  * 第三方资金
    * P2P资金
* 保险



# 业务流程





#  规则

* 限额（银行卡额度）

  * 单笔限额
  * 单日限额

* 通道维护

  * 银行维护  某家银行某个时间段维护
  * 通道维护  某家通道某个时间段维护

* 费用

* 渠道支持银行卡列表

  

* 

# 考虑点

* 节约成本

  > *在其他条件相同的情况下，我们更愿意使用更便宜的渠道* 
  >
  > 有2个通道，通道A的收费规则是单笔金额的2‰作为手续费，通道B的收费规则是1元1笔。那么，在其他条件相同的情况下，交易路由根据正常路由规则，会走到成本更低的通道上去，根据金额计算比如500块以下的订单金额就应该走到通道A,而500以上就是通道B 
  >
  > 目的：实现成本最低 

* 提高用户体验

  > *在其他条件相同的情况下，我们更愿意使用**到账时效快**的渠道*
  >
  > 提升支付成功率：
  >
  > 1、确保借款按时还款
  >
  > 2、确保流程流畅
  >
  > 3、用户体验

* 确保渠道可用

  > 提升支付成功率
  >
  > 需自动或手动切换到正常渠道：
  >
  > 1、渠道故障
  >
  > 2、渠道维护
  >
  > 3、失败率达到阈值
  >
  > 4、失败数达到阈值
  >
  > 需要记录当前通道的请求记录

  >有2个通道，通道A的收费规则是单笔金额的2‰作为手续费，通道B的收费规则是单笔费率的3‰。那么通道B基本只能用来做备份，在通道A维护的情况下使用，但是作为合作备胎也是有尊严的，你也是要时不时撩一下，给下希望，所以设定每天指定走B十万交易量，走完就全部走A. 
  >
  >目的：实现通道备份，为自动熔断可用性提供支持 

* 交易安全性

  > 有2个通道，通道A的收费规则是单笔金额的2‰作为手续费，通道B的收费规则是单笔费率的3‰。通道A需要支付要素【卡号、姓名、有效期】，通道B需要支付要素【卡号、姓名、证件类型、证件号、银行预留手机号、短信验证码、有效期、CVV】,此次交易命中风控规则，有交易风险，所以会下发通道B,即使费率更高也会走通道B，保证交易安全 

* 支持营销

  > 通过优先选择有优惠活动的通道，可以帮助业务提升付费客户量 

- 三方合作

  > 策略背后对应的是通道，通道都是对应银行或者三方，平时都要处理关系，所以很多时候需要切量且自然。 通过分流的路由规则，可以设定权重、限额，实现通道流量强制分配。以及通过流量分配算法形成或正态分布或强制策略达到各通道交易量控制。 
  >
  > 1、交易分流
  >
  > A. 商务层面（商务交涉）：由于BD一般要跟支付渠道打好关系，因此当支付渠道要求增加交易量时，可以通过每个支付渠道的交易量分流来实现。
  >
  > B. 系统层面：虽然某个支付渠道可能由于价格较高或者稳定性较差等原因，导致路由选择不到该支付渠道，但作为后续支付渠道的备份，系统仍需要少量的走一些交易到这些支付渠道。
  >
  > 正常的支付渠道可以不做交易量限制，或者设置为交易量无限大。需要设置交易量限制的渠道，可以按笔、按日、按月或者按日比例。

- 个性化支付定制

  > 1、限额控制
  >
  > 2、A/B测试

- 闭环控制

  > 设计良好的支付路由系统应该有闭环控制的能力，能够根据外界环境的变化（比如渠道/银行维护，断路）而对于相同的输入参数给出不同的输出结果。从而降低公司整体的运营成本。 



# 思路一

* 支付路由模块

  > 先带着支付四要素和支付用途先查询 ,看走哪个通道比较合适 

* 支付模块

  > 统一的发起代扣请求接口，代扣确认接口，代扣重新获取验证码接口，绑卡接口，绑卡确认接口，代付接口，订单查询接口，对账接口，支付路由查询接口 



# * 思路二

对于一个支付路由而言，设计时需要考量的因素有哪些呢？ 

从系统的输入与输出入手，阐述支付路由中需要考量的业务因素，继而推出路由算法以及背后的整体流程方案 

* 系统的输入与输出

  >

* 路由业务

  * 过滤性因素

    > 在一个支付方案在这个因素不被满足时，则整个系统就不会采纳这个支付方案 

    * 渠道/银行维护

      > 渠道和银行并不是总是在 7*24小时内保持有效。大部分时候渠道/银行会提前知会公司有关维护信息。

    * 渠道银行限额

      > 不同渠道银行在不同的支付产品下会有不同的限额设置，限额包括单笔限额，单日限额，单月限额。

    * 渠道银行交易频率限制：

      > 对于特定的渠道, 单卡的每日交易次数也是有所限制。

    * 渠道用户绑卡情况限制

      > 某些支付产品，渠道是需要先绑卡后使用，对于绑卡失败的用户，该渠道并不能被使用。

    * 可用渠道配置限制

      > 系统管理员可以根据公司签署的渠道和产品，在系统中配置相应产品对应的多种渠道。对于不在配置列表的方案，则不应予以采纳。

    * 白名单/黑名单限制

      > 支付请求可以对应相应的白名单和黑名单请求，表示在指定的渠道/指定以外的渠道内进行选择。

  * 选择性因素 

    * 渠道费率

      > 对于不同的渠道，相同的支付请求往往会对应不同的支付费率。费率比较是支付路由的核心比较之一 
      >
      > 1、单笔费率
      >
      > 2、总额费率
      >
      > 3、阶梯费率

    * QOS     

      > 不同的渠道由于其技术,运营水平的差异，往往对应不同的支付成功率。成功率比较也是支付路由的核心比较之一 
      >
      > 1、动态打分
      >
      > 渠道成功率

    * 营销策略

      >1、单笔优惠金额
      >
      >2、单笔折扣比例
      >
      >3、补贴总额度
      >
      >4、活动时间

* 路由算法

  * 锦标赛算法 -->  偏序比较

    > 过一轮又一轮的比赛，在每一轮的比赛中，失败者淘汰，优胜者晋级直至最终冠军的产生 

  * 循环赛算法 -->  权重比较 

    > 所有候选者都参与每一轮的比赛，根据排名座次分别取得一定的积分。最终所有候选人根据总积分决定优胜者 





# * 思路三

![20170815113224349](C:\Users\boyuan\Desktop\20170815113224349.jpeg)

* 产品类型：当然，路由时首选需要考虑渠道可以支持的支付产品。

* 费率：费率是路由最重要的一个指标。一般银行是按照额度来收费，部分是按照交易笔数来收费，复杂点的是阶梯收费，比如 10 万一个费率档次，100 万一个费率档次。
* 优惠活动：银行、第三方支付为了延揽客户，经常也会提供一些补贴给对接的商户，对于使用该渠道的交易进行补贴。而优惠的策略也是多种多样。
* 交易限额：不同通道会限制每次交易的金额上限，以及针对每个账户每天的额度限制。超过这个额度，需要变换通道。
* 卡类型：通道支持的信用卡或者借记卡。
* 通道的 QOS：掉单率、网络延迟以及接口能支持的 TPS，是路由的一个重要衡量因素。
* 资金头寸：电商公司在银行或者第三方平台的资金头寸。如果资金头寸不足，则不能使用这个通道来执行。
* 到账时效：对于转账，资金什么时候到目标账户上，也是影响路由选择的一个因素。
* 商户类型：不同类型的商户可以选择不同的通道。比如高性能、费率高的通道，预留给高级商户。



# * 思路四

![img](https://images2017.cnblogs.com/blog/885304/201712/885304-20171218194236646-1076494096.png) 





# * 思路五

![84579869_1](C:\Users\boyuan\Desktop\84579869_1.jpg)

* 引导路由 

  > 建立各行业不同引导模板及方案，展示控制场景支持支付方式展现和顺序，通过这个控制推荐支付从而达到影响用户支付行为的目的，并且引导模板支持特殊商家不同展现模板制定。
  >
  > 比如境外商户配置的银行要有Visa、Master；而境内的可能就可以忽略；主要业务信用卡还款的商户只能配置借记卡、而酒店、超市买卖的就可以信用卡、借记卡都能用。

* 交易路由

  > 通过交易路由规则能够做到把适合的交易推荐到合适的地方，达到降低成本的目的；本身路由规则能够控制通道维护时间处理和通过路由的运维策略实现自动熔断，也就是故障自动切换通道，保证成功率

* 分流路由



* 路由机制

  > 结合引导路由和交易路由，支付路由做为一个机制，它完整的承担了由用户需求体验满意度、支付成功率和收益率所构成的一个支付的收益管理职能。

  * 支付成本管理
    * 路由策略优先级次序实现收益最大化
    * 轻量化运营模块的技术支撑
    * 通道算法和策略控制
  * 支付方式覆盖面
    * 商户需求及引导，量身推荐支付方式
    * 可批量设置多商户多品牌营销活动
    * 支付产品、交易类型应用
  * 支付通道健康度
    * 分析流量、负载和通道智能分流
    * 针对系统维护、银行异常等事件的多支付通道智能切换



# 思路六

![img](http://image.woshipm.com/wp-files/2017/08/AHy6e6QJlEVPDtSk9ZZy.png) 

一种支付方式会关联多个目标机构，一种支付渠道可支持多种目标机构的支付，一个目标机构可同属于多种支付渠道 



# 思路七

* 初级阶段

  > 接入的支付渠道在2家及以下。该阶段的路由方案比较简单，有两种设计方案：
  >
  > A.某一渠道作为默认通道而另一渠道作为灾备通道。只有当默认通道的成功率或者拥堵率达到一定阈值时，系统自动或手动切至灾备通道。
  >
  > B.根据一定属性切量分别走不同渠道，例如卡BIN等。

* 中级阶段

  > 接入的支付渠道在2家至7家。在该阶段为了更进一步控制每一笔交易的路由成本，支付渠道路由方案可以不仅包含限制规则与优先规则，可以包含业务配置规则。

* 高级阶段

  > 接入的支付渠道在7家以上。由于支付渠道路由已实现全自动化选择，因此支付渠道路由方案只需要包含限制规则与优先规则即可 

 

# 其他

实际问题

* 用户问题
  * 余额不足
  * 不支持的银行卡



## 监控指标 

* 渠道监控
  * 背景
    * 特别是QPS大时，经常发生请求被限流或者请求超时等问题
    * 渠道网络不稳定 、系统出现问题

  * 指标
    * 连续失败笔数 
    * 五分钟内失败交易占比

 



## 真实环境

* 订单的支付状态

  * 初始化  INIT

    > 发起请求，创建本地订单

  * 未知  UNKNOW

    > 请求发送，中途遭遇网络波动或者第三方限流降级，可能发送成功，也可能发送失败
    >
    > 后续进行job轮询，查询本地未知状态的订单列表，再去第三方查询订单信息，一般是单个接口，非批量
    >
    > 注意：
    >
    > 1、同一时间不能大量请求第三方查询接口，避免被限流或者网络延迟，一定时间间隔发送一定量的请求
    >
    > 2、订单不存在的错误信息，则表示发送失败，可以发送邮件通知该状态的订单
    >
    > 3、银行维护等错误信息，则表示订单未知，可以发送邮件通知该状态的订单
    >
    > 2和3的后续处理待优化

  * 处理中 PROCESS

    > 请求发送成功，状态更新为处理中
    >
    > 后续进行job轮询，查询本地处理中状态的订单列表，再去第三方查询订单信息，一般是单个接口，非批
    >
    > 注意：
    >
    > 1、同一时间不能大量请求第三方查询接口，避免被限流或者网络延迟，一定时间间隔发送一定量的请求

  * 成功/失败  SUCCESS/FAIL

    >1、第三方回调  ，主动查询（job、手动触发接口）
    >
    >2、更改本地订单状态，回调业务接口
    >
    >3、需要有接口让业务方查询订单信息



---

#### 多种策略

可以设置多种策略，每种策略不同的走法

1、策略A： 过滤性因素(A\B\C)、选择性因素(A\B\C)

2、策略B： 过滤性因素(B\C\F)、选择性因素(A\B\D)

...



---

#### 可能遇见的坑

* 配置费率，需要一致
* 配置优惠，需要一致



---

#### 宋江贷

​	1、根据用户绑卡渠道来路由代扣渠道

​	2、渠道有成功率要求

---

#### QOS  

Quality of Service   服务质量

> 1、掉单率
>
> 2、网络延迟
>
> 3、TPS



---

#### ROI

> 1、投入产出比 
>
> 2、投资回报率（*ROI*）是指 通过投资而应返回的价值，即企业从一项投资活动中得到的经济回报 

路由方案

> 1、自动化程度
>
> 2、维护

---

#### 不错的网站

http://www.sohu.com/a/235139911_575744

https://blog.csdn.net/yin767833376/article/details/77529306









